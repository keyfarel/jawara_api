post:
  tags:
    - Authentication
  summary: Register User (Warga Baru)
  description: |
    Mendaftarkan user baru, membuat data Citizen, Family (KK), dan House.

    Aturan Dokumen:
    - `id_card_photo` bersifat OPSIONAL
    - Jika `selfie_photo` diupload, maka `id_card_photo` WAJIB
    - Jika hanya `id_card_photo` tanpa `selfie_photo`, registrasi tetap berhasil tanpa face verification

    Fitur Tambahan:
    - **Face Verification**: Jika `selfie_photo` diupload, sistem akan membandingkan wajah di selfie dengan wajah di KTP.

  requestBody:
    required: true
    content:
      multipart/form-data:
        schema:
          type: object
          required:
            - full_name
            - email
            - phone
            - password
            - password_confirmation
            - nik
            - gender
            - ownership_status
            - family_role
          properties:
            # --- Akun User ---
            full_name:
              type: string
              example: "John Doe"
            email:
              type: string
              format: email
              example: johndoe@example.com
            phone:
              type: string
              example: "081234567890"
            password:
              type: string
              format: password
              example: password123
            password_confirmation:
              type: string
              format: password
              example: password123

            # --- Data Citizen ---
            nik:
              type: string
              description: 16 digit NIK
              example: "3276012304980003"
            gender:
              type: string
              enum: [male, female]
              example: male

            # --- Dokumen & Biometrik ---
            id_card_photo:
              type: string
              format: binary
              nullable: true
              description: |
                [OPSIONAL] Foto KTP (jpg/png, max 5MB).
                Wajib jika ingin menggunakan fitur verifikasi wajah.

            selfie_photo:
              type: string
              format: binary
              nullable: true
              description: |
                [OPSIONAL] Foto Selfie Wajah.
                Jika diisi, akan dilakukan verifikasi wajah dengan KTP.
                Jika wajah tidak cocok, registrasi akan gagal.

            # --- Detail Tambahan ---
            birth_place:
              type: string
              nullable: true
              example: "Jakarta"
            birth_date:
              type: string
              format: date
              nullable: true
              example: "1990-01-01"
            religion:
              type: string
              nullable: true
              example: "Islam"
            blood_type:
              type: string
              nullable: true
              enum: [A, B, AB, O]
              example: "O"
            family_role:
              type: string
              enum: ["Kepala Keluarga", "Istri", "Anak", "Famili Lain"]
              example: "Kepala Keluarga"

            # --- Data Keluarga (KK) ---
            kk_number:
              type: string
              nullable: true
              description: 16 digit No KK (Opsional)
              example: "3276010000000001"
            ownership_status:
              type: string
              enum: [owner, renter, family, other]
              example: owner

            # --- Data Rumah (Pilih SATU opsi: ID atau Detail Baru) ---
            house_id:
              type: integer
              nullable: true
              description: Isi ID rumah jika ingin bergabung ke rumah yang sudah ada
              example: null

            # Jika house_id kosong, field di bawah ini wajib:
            custom_house_address:
              type: string
              nullable: true
              description: "Alamat rumah manual (Wajib jika house_id kosong)"
              example: "Jl. Mawar No. 12, Jakarta"

  responses:
    201:
      description: Register successful
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
                example: success
              message:
                type: string
                example: Register successful with face verification.
              data:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  token_type:
                    type: string
                    example: bearer
                  expires_in:
                    type: integer
                  user:
                    $ref: "../../schemas/user_full.yaml"

    422:
      description: Validation Error or Face Mismatch
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Verifikasi Wajah Gagal"
              errors:
                type: object
                properties:
                  selfie_photo:
                    type: array
                    items:
                      type: string
                    example: ["Wajah tidak cocok dengan KTP"]
